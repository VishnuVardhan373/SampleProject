package com.myproject.services.core.listeners;

import java.util.Iterator;

import org.apache.felix.scr.annotations.Activate;
import org.apache.felix.scr.annotations.Component;
import org.apache.felix.scr.annotations.Properties;
import org.apache.felix.scr.annotations.Property;
import org.apache.felix.scr.annotations.Service;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.event.Event;
import org.osgi.service.event.EventConstants;
import org.osgi.service.event.EventHandler;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.day.cq.dam.api.DamEvent;
import com.day.cq.replication.ReplicationEvent;
import com.day.cq.wcm.api.PageEvent;
import com.day.cq.wcm.api.PageModification;

  @Component(immediate=true)
  @Service
  @Properties({
	  @Property(name=EventConstants.EVENT_TOPIC ,value={ PageEvent.EVENT_TOPIC ,DamEvent.EVENT_TOPIC, ReplicationEvent.EVENT_TOPIC})
  })
public class CommonServiceHandler implements EventHandler{
	

	private static final Logger log=LoggerFactory.getLogger(CommonServiceHandler.class);
	
	@Override
	public void handleEvent(Event event) {
	log.debug("Handle Event Started : ");
	String eventTopic=event.getTopic();
	log.debug("Event Triggered By : {}",eventTopic);
	
	if(eventTopic.equals(PageEvent.EVENT_TOPIC)){
		log.debug("Page Event Triggered.");
		PageEvent pageEvent = PageEvent.fromEvent(event);
		
		//To Capture the Page Modifications
		Iterator<PageModification> modifications = pageEvent.getModifications();
		while(modifications.hasNext())
		{
			PageModification pageModification = modifications.next();
			log.debug("Page Modification Path : {}",pageModification.getPath());
			log.debug("Page Modification Type : {}",pageModification.getType());
			log.debug("Page Modification UserId : {}",pageModification.getUserId());
			log.debug("Page Modification Date : {}",pageModification.getModificationDate());

		}
	}
	else if(eventTopic.equals(DamEvent.EVENT_TOPIC)){
		log.debug("Dam Event Triggered.");
		DamEvent damEvent = DamEvent.fromEvent(event);
		
		//To Capture the Dam Asset Modification Details
		log.debug("Dam Modification Path : {} ",damEvent.getAssetPath());
		log.debug("Dam Modification Type : {} ",damEvent.getType());
		log.debug("Dam Modification UserId : {} ",damEvent.getUserId());
		log.debug("Dam Modification CreatedBy : {} ",damEvent.getCreatedBy());

	
	}
	else if(eventTopic.equals(ReplicationEvent.EVENT_TOPIC)){
		log.debug("Replication Event Triggered.");
		ReplicationEvent replicationEvent = ReplicationEvent.fromEvent(event);
		
		//To Capture the Replication Modification Details Active and DeActivate
		log.debug("Replication Path : {} ",replicationEvent.getReplicationAction().getPath());
		log.debug("Replication Type : {} ",replicationEvent.getReplicationAction().getType());
		log.debug("Replication UserId : {} ",replicationEvent.getReplicationAction().getUserId());
		log.debug("Replication Time : {} ",replicationEvent.getReplicationAction().getTime());


	}
		
	}
	
	@Activate
	protected void activate(ComponentContext context)
	{
		log.debug("=====================================");
		log.debug("Enter Event Handler:");
		log.debug("=====================================");

	}

}
